# POSTD Supabase Schema & Drift Audit Report

**Date**: 2025-01-16  
**Auditor**: POSTD Supabase Schema & Drift Auditor  
**Status**: ‚úÖ **AUDIT COMPLETE** - Actionable checklist provided

---

## Executive Summary

This audit compares the current repository state (migrations + code) against what should be in Supabase. The goal is to identify any remaining database changes, migrations, or RLS updates that need to be applied.

**Key Findings:**
- ‚úÖ **10 active migrations** identified (001-009 + 20250130 patch)
- ‚úÖ **Brand ID UUID migration** appears complete (migrations 003, 005, 006)
- ‚ö†Ô∏è **Migration 006** (drop legacy brand_id TEXT columns) may not be applied yet - **VERIFY**
- ‚úÖ **RLS policies** appear comprehensive in bootstrap migration
- ‚ö†Ô∏è **Code still uses `brand_id` (TEXT)** in some places - may need verification if migration 006 was applied
- ‚úÖ **Core tables** (brands, content_items, auto_plans, scheduled_content, media_assets) are properly defined

**Critical Action Items:**
1. **Verify migration 006 status** - If applied, legacy `brand_id` TEXT columns should be dropped
2. **Verify migration 005 status** - RLS policies should use `brand_id_uuid`, not `is_brand_member_text()`
3. **Test RLS policies** - Ensure brand isolation works correctly
4. **Verify `media_assets.status` column** - Migration 007 adds this, code expects it

---

## 0. Context Summary

### Canonical Tables for POSTD

Based on health docs and codebase analysis:

**Core Identity & Access:**
- `brands` - Main brand entity (UUID id, brand_kit JSONB)
- `brand_guide_versions` - Version history for brand guides
- `brand_members` - User-brand relationships with roles
- `tenants` - Workspace/tenant management
- `user_profiles` - User identity

**Content & Planning:**
- `content_items` - Primary content storage (posts, captions, scripts)
- `auto_plans` - Monthly content plans generated by Advisor Agent
- `scheduled_content` - Links content_items to scheduled publishing times
- `generation_logs` - AI generation audit trail

**Media & Assets:**
- `media_assets` - Media metadata (hash, path, brand_id UUID, status)
- `media_usage_logs` - Asset usage tracking
- `storage_quotas` - Brand storage limits

**Analytics:**
- `analytics_metrics` - Platform metrics (reach, engagement, followers)
- `analytics_sync_logs` - Sync operation history
- `analytics_goals` - Goal tracking
- `advisor_feedback` - Learning system feedback

**Publishing & Integrations:**
- `publishing_jobs` - Publishing queue
- `publishing_logs` - Publishing history
- `platform_connections` - OAuth token storage

**Approvals & Compliance:**
- `post_approvals` - Content approval tracking
- `client_settings` - Client preferences
- `audit_logs` - Activity audit trail
- `webhook_events` - Webhook processing
- `webhook_attempts` - Webhook retries
- `escalation_rules` - Escalation configuration
- `escalation_events` - Triggered escalations

**Persistence Schema (AI Learning Loop):**
- `strategy_briefs` - AI strategy briefs (uses `brand_id_uuid` after migration 005)
- `content_packages` - Content packages (uses `brand_id_uuid` after migration 005)
- `brand_history` - Brand activity log (uses `brand_id_uuid` after migration 005)
- `brand_success_patterns` - Success patterns (uses `brand_id_uuid` after migration 005)
- `collaboration_logs` - Agent collaboration (uses `brand_id_uuid` after migration 005)
- `performance_logs` - Performance tracking (uses `brand_id_uuid` after migration 005)
- `platform_insights` - Platform insights (uses `brand_id_uuid` after migration 005)
- `token_health` - OAuth token health (uses `brand_id_uuid` after migration 005)
- `weekly_summaries` - Weekly reports (uses `brand_id_uuid` after migration 005)
- `advisor_review_audits` - Advisor reviews (uses `brand_id_uuid` after migration 005)

### Health Docs Claims (Already Completed)

From `POSTD_REPO_HEALTH_STATUS.md`:
- ‚úÖ Branding migration completed (localStorage keys, Docker tags, user agent)
- ‚úÖ Environment variable template created
- ‚úÖ Connector scaffolds clearly marked
- ‚úÖ Legacy server entry point verified (already using v2)
- ‚úÖ Orphaned onboarding screens deleted
- ‚úÖ Documentation archive completed

**Database-related claims:**
- ‚úÖ Brand ID UUID migration mentioned in health docs (migrations 003, 005, 006)
- ‚úÖ RLS policies implemented in bootstrap migration
- ‚úÖ Media assets schema includes status column (migration 007)

---

## 1. MIGRATIONS: What Exists in the Repo

### Active Migrations (Chronological Order)

| # | Migration ID | Purpose | Risk Level | Notes |
|---|--------------|---------|------------|-------|
| 001 | `001_bootstrap_schema.sql` | Complete baseline schema (50+ tables, RLS policies) | ‚úÖ **Safe** | Single authoritative baseline. Safe to run on empty DB. Includes all core tables. |
| 002 | `002_create_brand_guide_versions.sql` | Brand guide version history table | ‚úÖ **Safe** | Idempotent (IF NOT EXISTS). Already in bootstrap, but safe for existing DBs. |
| 003 | `003_fix_brand_id_persistence_schema.sql` | Add `brand_id_uuid` columns to 10 persistence tables | ‚ö†Ô∏è **Important** | Step 1 of brand_id TEXT ‚Üí UUID migration. Adds columns, backfills data. |
| 004 | `004_activate_generation_logs_table.sql` | Activate generation_logs table | ‚úÖ **Safe** | Idempotent (IF NOT EXISTS). Table used by server/routes/agents.ts. |
| 005 | `005_finalize_brand_id_uuid_migration.sql` | Add FK constraints, update RLS to use `brand_id_uuid` | ‚ö†Ô∏è **Important** | Step 2 of migration. Updates RLS policies, adds FKs. **VERIFY THIS IS APPLIED**. |
| 006 | `006_drop_legacy_brand_id_text_columns.sql` | Drop deprecated `brand_id` TEXT columns | üî¥ **Potentially Dangerous** | Step 3 of migration. **IRREVERSIBLE**. Only apply after code migration complete. **VERIFY STATUS**. |
| 007 | `007_add_media_assets_status_and_rls.sql` | Add `status` column to `media_assets`, add INSERT/UPDATE RLS | ‚ö†Ô∏è **Important** | Code expects `status` column. Adds RLS policies for INSERT/UPDATE. |
| 014 | `014_content_planning_schema_clarification.sql` | Documentation-only migration | ‚úÖ **Safe** | No schema changes. Documents canonical tables (auto_plans, scheduled_content). |
| 009 | `009_consolidate_brand_guide_fields.sql` | Merge voice_summary, visual_summary, tone_keywords into brand_kit | ‚ö†Ô∏è **Important** | Data migration. Merges legacy fields into brand_kit JSONB. Additive only. |
| 010 | `20250130_brand_guide_versions_patch.sql` | Patch for brand_guide_versions (backward compatibility) | ‚úÖ **Safe** | Idempotent. Only creates table if it doesn't exist. |

### Migration Risk Assessment Details

#### ‚úÖ Safe Migrations (001, 002, 004, 008, 010)
- Use `IF NOT EXISTS` patterns
- Idempotent
- No data loss risk
- Can be applied multiple times safely

#### ‚ö†Ô∏è Important Migrations (003, 005, 007, 009)
- **003**: Adds columns, backfills data. Safe but verify backfill succeeded.
- **005**: Updates RLS policies. **CRITICAL** - If not applied, RLS may be broken for persistence tables.
- **007**: Adds `status` column. Code expects this - verify it exists.
- **009**: Data migration. Additive only, but verify merge succeeded.

#### üî¥ Potentially Dangerous (006)
- **IRREVERSIBLE** - Drops columns
- Only apply after:
  1. Migration 005 is applied (RLS uses `brand_id_uuid`)
  2. All application code uses `brand_id_uuid` (not `brand_id` TEXT)
  3. Verification that no code references `brand_id` TEXT columns
- **VERIFY STATUS BEFORE APPLYING**

### Legacy/Archived Migrations

All old migrations are in `supabase/migrations/_legacy/` or `supabase/migrations/archived/`. These should **NOT** be applied. The bootstrap migration (001) supersedes them.

---

## 2. CODE vs SCHEMA: Do We Expect Columns That Don't Exist?

### Core Tables Analysis

#### ‚úÖ `brands` Table
**Code Expectations:**
- `id` (UUID) - Primary key
- `brand_kit` (JSONB) - Canonical Brand Guide data
- `voice_summary` (JSONB) - Legacy (migration 009 merges into brand_kit)
- `visual_summary` (JSONB) - Legacy (migration 009 merges into brand_kit)
- `tone_keywords` (TEXT[]) - Legacy (migration 009 merges into brand_kit)

**Migration Status:**
- ‚úÖ Defined in `001_bootstrap_schema.sql`
- ‚úÖ Migration 009 merges legacy fields into `brand_kit`
- ‚ö†Ô∏è **Action**: Verify migration 009 applied (legacy fields should still exist but be deprecated)

#### ‚úÖ `brand_guide_versions` Table
**Code Expectations:**
- `id` (UUID)
- `brand_id` (UUID) - FK to brands
- `version` (INTEGER)
- `brand_guide` (JSONB)
- `changed_fields` (TEXT[])
- `changed_by` (UUID)
- `change_reason` (TEXT)

**Migration Status:**
- ‚úÖ Defined in `001_bootstrap_schema.sql`
- ‚úÖ Migration 002 creates it (idempotent)
- ‚úÖ Migration 20250130 patches it (idempotent)
- ‚úÖ **Status**: Should exist

#### ‚úÖ `content_items` Table
**Code Expectations:**
- `id` (UUID)
- `brand_id` (UUID) - Primary identifier
- `type` (TEXT)
- `content` (JSONB)
- `platform` (TEXT)
- `status` (TEXT)

**Migration Status:**
- ‚úÖ Defined in `001_bootstrap_schema.sql`
- ‚úÖ Uses `brand_id` UUID (not TEXT)
- ‚úÖ **Status**: Should exist with correct schema

#### ‚úÖ `auto_plans` Table
**Code Expectations:**
- `id` (UUID)
- `brand_id` (UUID) - Primary identifier
- `month` (DATE)
- `plan_data` (JSONB)
- `confidence` (NUMERIC)

**Migration Status:**
- ‚úÖ Defined in `001_bootstrap_schema.sql`
- ‚úÖ Uses `brand_id` UUID
- ‚úÖ Migration 008 documents this as canonical (no schema changes)
- ‚úÖ **Status**: Should exist. Code uses `auto_plans` (not `monthly_content_plans`)

#### ‚úÖ `scheduled_content` Table
**Code Expectations:**
- `id` (UUID)
- `brand_id` (UUID)
- `content_id` (UUID) - FK to content_items
- `scheduled_at` (TIMESTAMPTZ)
- `platforms` (TEXT[])

**Migration Status:**
- ‚úÖ Defined in `001_bootstrap_schema.sql`
- ‚úÖ Uses `brand_id` UUID
- ‚úÖ Migration 008 documents this as canonical
- ‚úÖ **Status**: Should exist

#### ‚ö†Ô∏è `media_assets` Table
**Code Expectations:**
- `id` (UUID)
- `brand_id` (UUID) - Primary identifier
- `tenant_id` (UUID)
- `category` (TEXT)
- `filename` (TEXT)
- `path` (TEXT)
- `hash` (TEXT)
- `mime_type` (TEXT)
- `size_bytes` (BIGINT)
- `status` (TEXT) - **EXPECTED BY CODE** (migration 007 adds this)
- `metadata` (JSONB)
- `used_in` (TEXT[])
- `usage_count` (INTEGER)

**Migration Status:**
- ‚úÖ Defined in `001_bootstrap_schema.sql`
- ‚ö†Ô∏è **Migration 007 adds `status` column** - **VERIFY THIS EXISTS**
- ‚ö†Ô∏è **Migration 007 adds INSERT/UPDATE RLS policies** - **VERIFY THESE EXIST**
- ‚úÖ Uses `brand_id` UUID (not TEXT)

**Code Usage:**
- `server/lib/media-service.ts` selects `status` column
- Code expects `status` to exist

**Action Required:**
- ‚úÖ Verify `status` column exists in `media_assets`
- ‚úÖ Verify INSERT/UPDATE RLS policies exist

#### ‚ö†Ô∏è Persistence Schema Tables (10 tables)
**Tables:** `strategy_briefs`, `content_packages`, `brand_history`, `brand_success_patterns`, `collaboration_logs`, `performance_logs`, `platform_insights`, `token_health`, `weekly_summaries`, `advisor_review_audits`

**Code Expectations:**
- **After migration 005**: Should use `brand_id_uuid` (UUID) as primary identifier
- **After migration 006**: Should **NOT** have `brand_id` (TEXT) column

**Migration Status:**
- ‚úÖ Migration 003: Adds `brand_id_uuid` columns, backfills data
- ‚ö†Ô∏è **Migration 005**: Updates RLS policies to use `brand_id_uuid`, adds FK constraints - **VERIFY APPLIED**
- üî¥ **Migration 006**: Drops `brand_id` TEXT columns - **VERIFY STATUS** (may not be applied yet)

**Code Usage:**
- `server/routes/onboarding.ts` uses `brand_id_uuid` (with fallback to `brand_id` for backward compatibility)
- `server/types/database.ts` defines `brandIdUuid` as primary identifier

**Action Required:**
- ‚úÖ Verify migration 005 applied (RLS policies use `brand_id_uuid`, FKs exist)
- ‚ö†Ô∏è **Verify migration 006 status** - If applied, `brand_id` TEXT columns should be dropped. If not applied, they may still exist.

### Potential Issues

#### Issue 1: `media_assets.status` Column
**Status**: ‚ö†Ô∏è **VERIFY**
- **Code expects**: `status` column (TEXT, NOT NULL, DEFAULT 'active')
- **Migration**: 007 adds this column
- **Action**: Verify column exists in Supabase

#### Issue 2: Persistence Schema `brand_id` TEXT Columns
**Status**: ‚ö†Ô∏è **VERIFY**
- **Migration 006**: Drops `brand_id` TEXT columns from 10 persistence tables
- **Code**: Uses `brand_id_uuid` with fallback to `brand_id` (for backward compatibility)
- **Action**: 
  - If migration 006 **NOT applied**: Columns still exist (OK, code has fallback)
  - If migration 006 **APPLIED**: Columns should be dropped (code fallback will fail - **RISK**)

#### Issue 3: RLS Policies on Persistence Tables
**Status**: ‚ö†Ô∏è **VERIFY**
- **Migration 005**: Updates RLS policies to use `brand_id_uuid` instead of `is_brand_member_text()`
- **Action**: Verify policies use `brand_id_uuid` (not `is_brand_member_text()`)

---

## 3. RLS & MULTI-TENANT CHECK

### RLS Status Overview

#### ‚úÖ Core Tables (Full RLS)
All core tables have RLS enabled with proper policies:
- `brands` - Brand members can view/manage
- `brand_members` - Users can view own memberships; admins can manage
- `content_items` - Brand members only
- `auto_plans` - Brand members only
- `scheduled_content` - Brand members only
- `post_approvals` - Brand members only
- `client_settings` - Clients + admins
- `audit_logs` - Admins only
- `platform_connections` - Brand members view, admins manage
- `analytics_metrics` - Brand members only
- `publishing_jobs` - Brand members only
- `notifications` - Own notifications only

**Status**: ‚úÖ **Correct** - Defined in `001_bootstrap_schema.sql`

#### ‚ö†Ô∏è `media_assets` RLS
**Migration 007 adds:**
- ‚úÖ INSERT policy: Brand members can insert
- ‚úÖ UPDATE policy: Brand members can update
- ‚úÖ SELECT policy: Should exist in bootstrap (verify)

**Action**: Verify INSERT/UPDATE policies exist

#### ‚ö†Ô∏è Persistence Schema Tables RLS
**Migration 005 updates:**
- ‚úÖ Policies should use `brand_id_uuid` (not `is_brand_member_text()`)
- ‚úÖ Policies should check `brand_members` table directly

**Helper Functions:**
- `is_brand_member_text(brand_id_param TEXT)` - **Should be dropped** if migration 006 applied
- `is_workspace_member(workspace_id_param TEXT)` - Still used for `milestones` table

**Action**: 
- ‚úÖ Verify persistence table policies use `brand_id_uuid`
- ‚úÖ Verify `is_brand_member_text()` is dropped (if migration 006 applied)

#### ‚úÖ `brand_guide_versions` RLS
**Status**: ‚úÖ **Correct**
- SELECT: Brand members can view versions for their brands
- UPDATE: Denied (immutable)
- DELETE: Denied (immutable)
- INSERT: Service role only (via API)

**Status**: ‚úÖ **Correct** - Defined in migrations 001, 002, 20250130

### RLS Helper Functions

| Function | Purpose | Status | Notes |
|----------|---------|--------|-------|
| `is_brand_member_text(brand_id_param TEXT)` | Checks brand membership for TEXT brand_id | ‚ö†Ô∏è **Should be dropped** | Used by persistence tables before migration 005. Should be dropped if migration 006 applied. |
| `is_workspace_member(workspace_id_param TEXT)` | Checks workspace membership | ‚úÖ **Active** | Used by `milestones` table. Still needed. |
| `update_updated_at()` | Trigger function for timestamps | ‚úÖ **Active** | Used by all tables with `updated_at` columns. |

**Action**: Verify `is_brand_member_text()` is dropped if migration 006 applied.

---

## 4. WHAT *YOU* NEED TO DO IN SUPABASE (CHECKLIST)

### 4.1 Local Supabase Checklist

#### Step 1: Verify Current Migration Status

1. **Check which migrations have been applied:**
   ```sql
   -- In Supabase Dashboard ‚Üí SQL Editor
   -- Check if migration tracking table exists (if you use one)
   SELECT * FROM supabase_migrations.schema_migrations;
   -- OR check table existence directly
   ```

2. **Verify core tables exist:**
   ```sql
   SELECT table_name 
   FROM information_schema.tables 
   WHERE table_schema = 'public' 
   AND table_name IN (
     'brands', 'brand_guide_versions', 'content_items', 
     'auto_plans', 'scheduled_content', 'media_assets',
     'strategy_briefs', 'content_packages', 'brand_history'
   )
   ORDER BY table_name;
   ```
   **Expected**: All tables should exist.

3. **Verify `media_assets.status` column exists:**
   ```sql
   SELECT column_name, data_type, is_nullable, column_default
   FROM information_schema.columns
   WHERE table_name = 'media_assets'
   AND column_name = 'status';
   ```
   **Expected**: Column should exist with `data_type = 'text'`, `is_nullable = 'NO'`, `column_default = 'active'::text'`

4. **Verify persistence schema `brand_id_uuid` columns exist:**
   ```sql
   SELECT table_name, column_name, data_type
   FROM information_schema.columns
   WHERE table_name IN (
     'strategy_briefs', 'content_packages', 'brand_history',
     'brand_success_patterns', 'collaboration_logs', 'performance_logs',
     'platform_insights', 'token_health', 'weekly_summaries', 'advisor_review_audits'
   )
   AND column_name = 'brand_id_uuid';
   ```
   **Expected**: Should return 10 rows (one per table).

5. **Verify persistence schema `brand_id` TEXT columns status:**
   ```sql
   SELECT table_name, column_name, data_type
   FROM information_schema.columns
   WHERE table_name IN (
     'strategy_briefs', 'content_packages', 'brand_history',
     'brand_success_patterns', 'collaboration_logs', 'performance_logs',
     'platform_insights', 'token_health', 'weekly_summaries', 'advisor_review_audits'
   )
   AND column_name = 'brand_id';
   ```
   **Expected**: 
   - **If migration 006 NOT applied**: Should return 10 rows (columns still exist)
   - **If migration 006 APPLIED**: Should return 0 rows (columns dropped)

6. **Verify RLS policies on persistence tables use `brand_id_uuid`:**
   ```sql
   SELECT tablename, policyname, cmd, qual
   FROM pg_policies
   WHERE tablename IN (
     'strategy_briefs', 'content_packages', 'brand_history',
     'brand_success_patterns', 'collaboration_logs', 'performance_logs',
     'platform_insights', 'token_health', 'weekly_summaries', 'advisor_review_audits'
   )
   AND qual LIKE '%brand_id_uuid%';
   ```
   **Expected**: Should return multiple rows (policies using `brand_id_uuid`).

7. **Verify `is_brand_member_text()` function status:**
   ```sql
   SELECT routine_name
   FROM information_schema.routines
   WHERE routine_name = 'is_brand_member_text';
   ```
   **Expected**:
   - **If migration 006 NOT applied**: Should return 1 row (function still exists)
   - **If migration 006 APPLIED**: Should return 0 rows (function dropped)

#### Step 2: Apply Missing Migrations

**‚ö†Ô∏è IMPORTANT**: Only apply migrations that haven't been applied yet. Check status first.

1. **Apply migration 001 (bootstrap) if database is empty:**
   ```bash
   # In Supabase Dashboard ‚Üí SQL Editor
   # Copy and paste contents of supabase/migrations/001_bootstrap_schema.sql
   # Click "Run"
   ```
   **Note**: This is safe to run on empty database. Uses `IF NOT EXISTS` patterns.

2. **Apply migration 002 (brand_guide_versions) if needed:**
   ```bash
   # Copy and paste contents of supabase/migrations/002_create_brand_guide_versions.sql
   ```
   **Note**: Idempotent (IF NOT EXISTS).

3. **Apply migration 003 (brand_id_uuid columns) if needed:**
   ```bash
   # Copy and paste contents of supabase/migrations/003_fix_brand_id_persistence_schema.sql
   ```
   **Note**: Adds columns, backfills data. Safe but verify backfill succeeded.

4. **Apply migration 004 (generation_logs) if needed:**
   ```bash
   # Copy and paste contents of supabase/migrations/004_activate_generation_logs_table.sql
   ```
   **Note**: Idempotent (IF NOT EXISTS).

5. **Apply migration 005 (finalize brand_id_uuid) if needed:**
   ```bash
   # Copy and paste contents of supabase/migrations/005_finalize_brand_id_uuid_migration.sql
   ```
   **‚ö†Ô∏è CRITICAL**: This updates RLS policies. Verify policies after applying.

6. **Apply migration 007 (media_assets status) if needed:**
   ```bash
   # Copy and paste contents of supabase/migrations/007_add_media_assets_status_and_rls.sql
   ```
   **Note**: Adds `status` column and RLS policies. Code expects this.

7. **Apply migration 009 (consolidate brand_guide_fields) if needed:**
   ```bash
   # Copy and paste contents of supabase/migrations/009_consolidate_brand_guide_fields.sql
   ```
   **Note**: Data migration. Merges legacy fields into `brand_kit`. Additive only.

8. **Apply migration 20250130 (brand_guide_versions patch) if needed:**
   ```bash
   # Copy and paste contents of supabase/migrations/20250130_brand_guide_versions_patch.sql
   ```
   **Note**: Idempotent (IF NOT EXISTS).

9. **üî¥ DO NOT APPLY migration 006 yet:**
   - **Only apply after:**
     - Migration 005 is applied and verified
     - All application code uses `brand_id_uuid` (verify codebase)
     - You've verified no code references `brand_id` TEXT columns
   - **This migration is IRREVERSIBLE**

#### Step 3: Schema Spot-Checks

1. **Verify `auto_plans` table:**
   ```sql
   SELECT column_name, data_type, is_nullable
   FROM information_schema.columns
   WHERE table_name = 'auto_plans'
   ORDER BY ordinal_position;
   ```
   **Expected columns**: `id` (uuid), `brand_id` (uuid), `month` (date), `plan_data` (jsonb), `confidence` (numeric), `created_at`, `updated_at`

2. **Verify `media_assets` table:**
   ```sql
   SELECT column_name, data_type, is_nullable, column_default
   FROM information_schema.columns
   WHERE table_name = 'media_assets'
   AND column_name IN ('id', 'brand_id', 'status', 'path', 'hash')
   ORDER BY column_name;
   ```
   **Expected**: All columns should exist. `status` should have default `'active'::text'`

3. **Verify `brands.brand_kit` column:**
   ```sql
   SELECT column_name, data_type
   FROM information_schema.columns
   WHERE table_name = 'brands'
   AND column_name = 'brand_kit';
   ```
   **Expected**: Should exist with `data_type = 'jsonb'`

#### Step 4: RLS Spot-Checks

1. **Verify RLS is enabled on key tables:**
   ```sql
   SELECT tablename, rowsecurity
   FROM pg_tables
   WHERE schemaname = 'public'
   AND tablename IN (
     'brands', 'content_items', 'auto_plans', 
     'scheduled_content', 'media_assets', 'analytics_metrics'
   )
   ORDER BY tablename;
   ```
   **Expected**: All should have `rowsecurity = true`

2. **Verify `media_assets` INSERT/UPDATE policies:**
   ```sql
   SELECT policyname, cmd, qual, with_check
   FROM pg_policies
   WHERE tablename = 'media_assets'
   AND cmd IN ('INSERT', 'UPDATE');
   ```
   **Expected**: Should return 2 rows (INSERT and UPDATE policies)

3. **Verify persistence tables use `brand_id_uuid` in policies:**
   ```sql
   SELECT tablename, policyname, qual
   FROM pg_policies
   WHERE tablename = 'strategy_briefs'
   AND qual LIKE '%brand_id_uuid%';
   ```
   **Expected**: Should return multiple rows (policies using `brand_id_uuid`)

#### Step 5: Local Behavior Tests

1. **Create a test brand:**
   - Use your application UI or API
   - Verify brand is created in `brands` table

2. **Create a brand guide:**
   - Update brand guide via UI/API
   - Verify `brand_guide_versions` table has a new row

3. **Generate a content plan:**
   - Trigger auto-planner (Advisor Agent)
   - Verify `auto_plans` table has a new row with correct `brand_id`

4. **Create content items:**
   - Generate content via Doc/Design agents
   - Verify `content_items` table has new rows

5. **Upload media assets:**
   - Upload an image via UI/API
   - Verify `media_assets` table has a new row with `status = 'active'`

6. **Test brand isolation:**
   - Create two brands (Brand A and Brand B)
   - As a user in Brand A, verify you cannot see Brand B's:
     - Content items
     - Auto plans
     - Media assets
     - Analytics metrics

---

### 4.2 Staging/Production Supabase Checklist

**‚ö†Ô∏è MORE CONSERVATIVE - Non-destructive verification first**

#### Step 1: Backups

1. **Before applying ANY new migration:**
   - ‚úÖ Create a database backup/snapshot in Supabase Dashboard
   - ‚úÖ Document current migration status
   - ‚úÖ Test migrations in local/staging first

#### Step 2: Verify Current State (Non-destructive)

1. **Run all verification queries from Step 1 of Local Checklist**
   - Document results
   - Identify which migrations need to be applied

2. **Check for data integrity:**
   ```sql
   -- Verify brand_id_uuid columns are populated (if migration 003 applied)
   SELECT 
     'strategy_briefs' as table_name,
     COUNT(*) as total_rows,
     COUNT(brand_id_uuid) as rows_with_uuid,
     COUNT(*) - COUNT(brand_id_uuid) as rows_missing_uuid
   FROM strategy_briefs
   UNION ALL
   SELECT 'content_packages', COUNT(*), COUNT(brand_id_uuid), COUNT(*) - COUNT(brand_id_uuid)
   FROM content_packages;
   -- Repeat for other persistence tables
   ```
   **Expected**: `rows_missing_uuid` should be 0 (all rows have `brand_id_uuid`)

3. **Check for orphaned data:**
   ```sql
   -- Verify brand_id_uuid values reference existing brands
   SELECT COUNT(*)
   FROM strategy_briefs s
   LEFT JOIN brands b ON s.brand_id_uuid = b.id
   WHERE s.brand_id_uuid IS NOT NULL
   AND b.id IS NULL;
   ```
   **Expected**: Should return 0 (no orphaned references)

#### Step 3: Apply Migrations (During Maintenance Window)

**‚ö†Ô∏è Apply only migrations that haven't been applied yet**

1. **Migration 001 (bootstrap)**: Only if database is empty or missing tables
2. **Migration 002**: Idempotent, safe to apply
3. **Migration 003**: Verify backfill succeeded after applying
4. **Migration 004**: Idempotent, safe to apply
5. **Migration 005**: ‚ö†Ô∏è **Apply during maintenance window** - Updates RLS policies
6. **Migration 007**: ‚ö†Ô∏è **Apply during maintenance window** - Adds column and RLS policies
7. **Migration 009**: ‚ö†Ô∏è **Apply during maintenance window** - Data migration
8. **Migration 20250130**: Idempotent, safe to apply
9. **Migration 006**: üî¥ **DO NOT APPLY YET** - Only after full code migration verified

#### Step 4: RLS & Security Verification

1. **Verify RLS is enabled on all tenant-scoped tables:**
   ```sql
   SELECT tablename, rowsecurity
   FROM pg_tables
   WHERE schemaname = 'public'
   AND tablename IN (
     'brands', 'content_items', 'auto_plans', 'scheduled_content',
     'media_assets', 'analytics_metrics', 'platform_connections',
     'publishing_jobs', 'post_approvals', 'client_settings'
   )
   ORDER BY tablename;
   ```
   **Expected**: All should have `rowsecurity = true`

2. **Verify policies use correct helper functions:**
   ```sql
   -- Check for policies using deprecated is_brand_member_text()
   SELECT tablename, policyname, qual
   FROM pg_policies
   WHERE qual LIKE '%is_brand_member_text%';
   ```
   **Expected**: Should return 0 rows (if migration 005 applied)

3. **Verify persistence tables use brand_id_uuid in policies:**
   ```sql
   SELECT tablename, COUNT(*) as policy_count
   FROM pg_policies
   WHERE tablename IN (
     'strategy_briefs', 'content_packages', 'brand_history'
   )
   AND qual LIKE '%brand_id_uuid%'
   GROUP BY tablename;
   ```
   **Expected**: Each table should have multiple policies using `brand_id_uuid`

#### Step 5: Smoke Tests

1. **Test brand isolation:**
   - Log in as test user in Brand A
   - Verify you cannot see Brand B's:
     - Content items
     - Auto plans
     - Media assets
     - Analytics metrics
   - Verify you CAN see Brand A's data

2. **Test content generation flow:**
   - Run a scrape/onboarding for a test brand
   - Verify:
     - Brand Guide saves to `brands.brand_kit`
     - Brand Guide version created in `brand_guide_versions`
     - Content plan generated in `auto_plans`
     - Media assets persist in `media_assets` with `status = 'active'`
     - Scheduled content rows appear in `scheduled_content`

3. **Test media asset upload:**
   - Upload an image
   - Verify:
     - Row created in `media_assets` with `status = 'active'`
     - RLS policies allow INSERT/UPDATE for brand members

4. **Test analytics:**
   - Trigger analytics sync
   - Verify:
     - Rows created in `analytics_metrics`
     - Brand isolation works (Brand A cannot see Brand B's metrics)

---

## 5. OUTPUT SUMMARY

### Repo Schema Summary

**Canonical Database Structure:**
- **50+ tables** defined in `001_bootstrap_schema.sql`
- **Core tables**: `brands`, `brand_guide_versions`, `content_items`, `auto_plans`, `scheduled_content`, `media_assets`
- **Persistence schema**: 10 tables using `brand_id_uuid` (UUID) after migration 005
- **RLS policies**: Comprehensive coverage on all tenant-scoped tables
- **Helper functions**: `is_workspace_member()` (active), `is_brand_member_text()` (should be dropped if migration 006 applied)

### Migration Table

| Migration | Purpose | Risk | Status |
|-----------|---------|------|--------|
| 001 | Bootstrap schema | ‚úÖ Safe | Should be applied |
| 002 | Brand guide versions | ‚úÖ Safe | Should be applied |
| 003 | Add brand_id_uuid columns | ‚ö†Ô∏è Important | Should be applied |
| 004 | Activate generation_logs | ‚úÖ Safe | Should be applied |
| 005 | Finalize brand_id_uuid (FKs, RLS) | ‚ö†Ô∏è Important | **VERIFY APPLIED** |
| 006 | Drop legacy brand_id TEXT | üî¥ Dangerous | **VERIFY STATUS** |
| 007 | Media assets status + RLS | ‚ö†Ô∏è Important | **VERIFY APPLIED** |
| 008 | Documentation only | ‚úÖ Safe | No action needed |
| 009 | Consolidate brand_guide fields | ‚ö†Ô∏è Important | Should be applied |
| 20250130 | Brand guide versions patch | ‚úÖ Safe | Should be applied |

### Code vs Schema Mismatches

1. **`media_assets.status` column**: Code expects this, migration 007 adds it - **VERIFY EXISTS**
2. **Persistence schema `brand_id` TEXT columns**: Code has fallback - **VERIFY STATUS** (migration 006)
3. **RLS policies on persistence tables**: Should use `brand_id_uuid` - **VERIFY** (migration 005)

### RLS Status Overview

| Table Category | RLS Status | Helper Functions | Notes |
|----------------|------------|------------------|-------|
| Core tables | ‚úÖ Correct | Direct brand_members check | All have proper RLS |
| `media_assets` | ‚ö†Ô∏è Verify | Direct brand_members check | Migration 007 adds INSERT/UPDATE policies |
| Persistence tables | ‚ö†Ô∏è Verify | Should use `brand_id_uuid` | Migration 005 updates policies |
| `brand_guide_versions` | ‚úÖ Correct | Direct brand_members check | Immutable (no UPDATE/DELETE) |

---

## Critical Action Items Summary

1. **‚úÖ Verify migration 005 applied** - RLS policies should use `brand_id_uuid`
2. **‚ö†Ô∏è Verify migration 006 status** - If applied, `brand_id` TEXT columns should be dropped
3. **‚úÖ Verify migration 007 applied** - `media_assets.status` column should exist
4. **‚úÖ Test RLS policies** - Ensure brand isolation works correctly
5. **‚ö†Ô∏è Verify persistence schema** - All 10 tables should have `brand_id_uuid` columns populated

---

**Report Generated**: 2025-01-16  
**Next Review**: After applying/verifying migrations in Supabase

