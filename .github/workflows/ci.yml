name: CI

on:
  push:
    branches: [main, develop, integration-v2]
  pull_request:
    branches: [main, develop, integration-v2]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 10.14.0
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run lint
      - name: Lint Results
        run: echo "✅ Lint check passed"

  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 10.14.0
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run typecheck
      - name: Typecheck Results
        run: echo "✅ TypeScript check passed"

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 10.14.0
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run test:ci
        continue-on-error: false
      - name: Test Results
        run: echo "✅ Test check passed"

  e2e:
    name: E2E Tests (Responsive UI)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 10.14.0
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      # NOTE: Build step is intentionally non-blocking for E2E job
      # E2E tests may run even if build has warnings, but build failures will be reported
      - run: pnpm run build
        continue-on-error: true
      - run: pnpm exec playwright install
      # NOTE: E2E tests are informational only - failures don't block CI
      # This allows E2E tests to run and report issues without blocking deployments
      # E2E test results are uploaded as artifacts for review
      - run: pnpm run e2e
        continue-on-error: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
          retention-days: 7
      - name: E2E Results
        run: echo "⚠️ E2E tests completed (non-blocking). See artifacts for screenshots and videos."

  # Brand Health Check - Optional, runs when BRAND_TEST_ID secret is configured
  # This verifies the scraper and content pipeline work with real brand data
  brand-health:
    name: Brand Health Check
    runs-on: ubuntu-latest
    # Only run if the secret is configured (set BRAND_TEST_ID in repo secrets)
    if: ${{ vars.BRAND_TEST_ID != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 10.14.0
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      
      # Scraper smoke test - verifies brand kit, colors, images, no duplicates
      - name: Scraper Health Check
        run: pnpm scraper:smoke
        continue-on-error: true
        env:
          SCRAPER_TEST_BRAND_ID_1: ${{ vars.BRAND_TEST_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      
      # Brand experience smoke - verifies content pipeline, queue, media assets
      - name: Brand Experience Check
        run: pnpm brand-experience:smoke
        continue-on-error: true
        env:
          BRAND_EXPERIENCE_TEST_BRAND_ID: ${{ vars.BRAND_TEST_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      
      - name: Brand Health Results
        run: echo "⚠️ Brand health checks completed (non-blocking). Review logs for any issues."

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 10.14.0
      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm run build
        continue-on-error: false
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          retention-days: 5

  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, e2e, build, brand-health]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          if [ "${{ needs.build.result }}" = "failure" ]; then
            echo "❌ Build failed - blocking issue"
            exit 1
          fi
          if [ "${{ needs.typecheck.result }}" = "failure" ]; then
            echo "❌ Typecheck failed - blocking issue"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" = "failure" ]; then
            echo "❌ Lint failed - blocking issue"
            exit 1
          fi
          echo "✅ CI pipeline complete"
          echo "Build: ${{ needs.build.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Typecheck: ${{ needs.typecheck.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "E2E: ${{ needs.e2e.result }} (non-blocking)"
          echo "Brand Health: ${{ needs.brand-health.result }} (non-blocking, optional)"
